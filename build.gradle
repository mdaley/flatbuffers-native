plugins {
    id 'java'
}

group 'com.sequsoft.flatbuffers-native'
version '1.12.0.1-SNAPSHOT'

sourceCompatibility = 1.8

repositories {
    mavenCentral()
}

dependencies {
    testImplementation group: 'junit', name: 'junit', version: '4.12'
}

task displayProjectProperties {

    doLast() {

        for(Map.Entry p: project.getProperties()) {
            println(p.toString() + "\n");
        }
    }
}

class DockerBuilder extends DefaultTask {
    private String source
    private String image

    @Option(option = "source", description = "The name of the source Dockerfile")
    void setSource(String source) {
        this.source = source
    }

    @Option(option = "image", description = "name of the image that will be produced")
    void setImage(String image) {
        this.image = image
    }

    @Input
    String getSource() {
        return source
    }

    @Input
    String getImage() {
        return image
    }

    @TaskAction
    void build() {
        println "docker build -t ${image} -f ${source} ."
    }
}

List<Task> dockerBuildTasks = new ArrayList<>();

/*task loopPlatforms() {
    doLast {

        file("./platforms").eachDir { os ->
            file(os).eachDir { arch ->
                println arch.path
                def innerTask = tasks.register("myTask${arch.path}", DockerBuilder) {
                    dir = arch.path
                }

                dockerBuildTasks.add(innerTask)
            }
        }

        ext.dockerBuildTasks = tasks
    }
}*/

/*task buildImages(type:Exec) {
    dependsOn loopPlatforms
    workingDir project.projectDir
    commandLine './make-docker-build-images'
    println(dockerBuildTasks)
}*/

task mytask() {
    println "Hello!"
}

file("./platforms").eachDir { os ->
    file(os).eachDir { arch ->
        println arch.path
        def osName = os.toString().substring(os.toString().lastIndexOf("/") + 1)
        def archName = arch.toString().substring(arch.toString().lastIndexOf("/") + 1)
        def name = "dockerBuild_${osName}_${archName}"
        println name

        def innerTask = tasks.register(name, DockerBuilder) {
            source = "${arch.path}/Dockerfile"
            image = "fbbuild-${osName}-${archName}"
        }

        innerTask

        dockerBuildTasks.add(innerTask)
    }
}

build.dependsOn  {
    mytask
    dockerBuildTasks
}